{% extends "layout.html" %}

{% block title %}
    Discover Your Ikigai
{% endblock %}

{% block main %}

<div class="exercise-container">
    <!-- Hero Message -->
    <div id="heroMessage" style="text-align: center; padding: 40px 20px 30px; background: linear-gradient(135deg, rgba(11, 183, 183, 0.05) 0%, rgba(237, 74, 109, 0.05) 100%); border-radius: 20px; margin-bottom: 30px;">
        <h1 style="color: var(--navy); font-size: 36px; margin-bottom: 10px; font-weight: bold;">‚ú® {{ t('unlock_treasure') }} ‚ú®</h1>
        <p style="color: var(--teal-dark); font-size: 16px; max-width: 600px; margin: 0 auto 15px;">
            {{ t('get_ready') }} <strong style="color: var(--pink);">{{ t('superpowers') }}</strong> {{ t('god_placed') }} ü¶∏‚Äç‚ôÇÔ∏è
        </p>
        <div style="display: inline-block; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: white; padding: 10px 25px; border-radius: 25px; font-weight: bold; font-size: 14px; box-shadow: 0 5px 15px rgba(255, 165, 0, 0.3);">
            üèÑ‚Äç‚ôÇÔ∏è {{ t('earn_points') }}
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-bar-fill" id="progressBar"></div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="step-indicator" id="stepIndicator">{{ t('step_of', current=1, total=10) }}</div>
        <div id="saveIndicator" style="font-size: 12px; color: var(--turquoise); opacity: 0; transition: opacity 0.3s;">
            ‚úì {{ t('saved') }}
        </div>
    </div>

    <!-- Step 1: What You Love -->
    <div class="step-content active" id="step1" data-step="1" data-time="180">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle1">
                <div class="timer-text" id="timer1">3:00</div>
            </div>
        </div>
        <h2 class="step-title">{{ t('what_you_love') }}</h2>
        <p class="step-description">{{ t('what_you_love_desc') }}</p>
        
        <div class="input-group category-love" id="loveInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="4">
            </div>
            <div class="input-item">
                <div class="input-number">6</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="5">
            </div>
            <div class="input-item">
                <div class="input-number">7</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="6">
            </div>
            <div class="input-item">
                <div class="input-number">8</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="7">
            </div>
            <div class="input-item">
                <div class="input-number">9</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="8">
            </div>
            <div class="input-item">
                <div class="input-number">10</div>
                <input type="text" class="input-field" placeholder="{{ t('something_love') }}" data-category="love" data-index="9">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="pauseTimer(1)" id="pauseBtn1">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 2: What You're Good At -->
    <div class="step-content" id="step2" data-step="2" data-time="180">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle2">
                <div class="timer-text" id="timer2">3:00</div>
            </div>
        </div>
        <h2 class="step-title">{{ t('what_good_at') }}</h2>
        <p class="step-description">{{ t('what_good_at_desc') }}</p>
        
        <div class="input-group category-good" id="goodInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="4">
            </div>
            <div class="input-item">
                <div class="input-number">6</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="5">
            </div>
            <div class="input-item">
                <div class="input-number">7</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="6">
            </div>
            <div class="input-item">
                <div class="input-number">8</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="7">
            </div>
            <div class="input-item">
                <div class="input-number">9</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="8">
            </div>
            <div class="input-item">
                <div class="input-number">10</div>
                <input type="text" class="input-field" placeholder="{{ t('skill_talent') }}" data-category="good" data-index="9">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(2)" id="pauseBtn2">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 3: What You Can Be Paid For -->
    <div class="step-content" id="step3" data-step="3" data-time="180">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle3">
                <div class="timer-text" id="timer3">3:00</div>
            </div>
        </div>
        <h2 class="step-title">{{ t('what_paid_for') }}</h2>
        <p class="step-description">{{ t('what_paid_for_desc') }}</p>
        
        <div class="input-group category-paid" id="paidInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="4">
            </div>
            <div class="input-item">
                <div class="input-number">6</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="5">
            </div>
            <div class="input-item">
                <div class="input-number">7</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="6">
            </div>
            <div class="input-item">
                <div class="input-number">8</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="7">
            </div>
            <div class="input-item">
                <div class="input-number">9</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="8">
            </div>
            <div class="input-item">
                <div class="input-number">10</div>
                <input type="text" class="input-field" placeholder="{{ t('way_earn') }}" data-category="paid" data-index="9">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(3)" id="pauseBtn3">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 4: What The World Needs -->
    <div class="step-content" id="step4" data-step="4" data-time="180">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle4">
                <div class="timer-text" id="timer4">3:00</div>
            </div>
        </div>
        <h2 class="step-title">{{ t('what_world_needs') }}</h2>
        <p class="step-description">{{ t('what_world_needs_desc') }}</p>
        
        <div class="input-group category-needs" id="needsInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="4">
            </div>
            <div class="input-item">
                <div class="input-number">6</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="5">
            </div>
            <div class="input-item">
                <div class="input-number">7</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="6">
            </div>
            <div class="input-item">
                <div class="input-number">8</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="7">
            </div>
            <div class="input-item">
                <div class="input-number">9</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="8">
            </div>
            <div class="input-item">
                <div class="input-number">10</div>
                <input type="text" class="input-field" placeholder="{{ t('problem_solve') }}" data-category="needs" data-index="9">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(4)" id="pauseBtn4">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 5: Passion (Love + Good At) -->
    <div class="step-content" id="step5" data-step="5" data-time="120">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle5">
                <div class="timer-text" id="timer5">2:00</div>
            </div>
        </div>
        <h2 class="step-title">üíñ {{ t('your_passion') }}</h2>
        <p class="step-description">{{ t('your_passion_desc') }}</p>
        
        <!-- Show previous answers -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; padding: 20px; background: var(--light-gray); border-radius: 15px;">
            <div style="padding: 15px; background: rgba(237, 74, 109, 0.1); border-radius: 10px; border-left: 3px solid var(--pink);">
                <h4 style="color: var(--pink); margin-bottom: 10px; font-size: 14px;">‚ù§Ô∏è {{ t('what_you_love') }}:</h4>
                <div id="reviewLove" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
            <div style="padding: 15px; background: rgba(0, 159, 213, 0.1); border-radius: 10px; border-left: 3px solid var(--sky-blue);">
                <h4 style="color: var(--sky-blue); margin-bottom: 10px; font-size: 14px;">‚≠ê {{ t('what_good_at') }}:</h4>
                <div id="reviewGood" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
        </div>
        
        <!-- AI Suggestions Button -->
        <div id="aiContainer5" class="ai-container" style="text-align: center; margin-bottom: 20px; display: none;">
            <button class="btn btn-secondary" onclick="getAISuggestions('passion', 'love', 'good')" id="aiBtn5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                ‚ú® {{ t('ai_suggestions') }}
            </button>
            <div id="aiLoading5" style="display: none; margin-top: 10px; color: var(--purple);">
                <span class="spinner-border spinner-border-sm" role="status"></span> {{ t('analyzing_ai') }}
            </div>
        </div>
        
        <div class="input-group category-passion" id="passionInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="passion" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="passion" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="passion" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="passion" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="passion" data-index="4">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(5)" id="pauseBtn5">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 6: Mission (Love + World Needs) -->
    <div class="step-content" id="step6" data-step="6" data-time="120">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle6">
                <div class="timer-text" id="timer6">2:00</div>
            </div>
        </div>
        <h2 class="step-title">üéØ {{ t('your_mission') }}</h2>
        <p class="step-description">{{ t('your_mission_desc') }}</p>
        
        <!-- Show previous answers -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; padding: 20px; background: var(--light-gray); border-radius: 15px;">
            <div style="padding: 15px; background: rgba(237, 74, 109, 0.1); border-radius: 10px; border-left: 3px solid var(--pink);">
                <h4 style="color: var(--pink); margin-bottom: 10px; font-size: 14px;">‚ù§Ô∏è {{ t('what_you_love') }}:</h4>
                <div id="reviewLove2" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
            <div style="padding: 15px; background: rgba(157, 128, 185, 0.1); border-radius: 10px; border-left: 3px solid var(--purple);">
                <h4 style="color: var(--purple); margin-bottom: 10px; font-size: 14px;">üåç {{ t('what_world_needs') }}:</h4>
                <div id="reviewNeeds" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
        </div>
        
        <!-- AI Suggestions Button -->
        <div id="aiContainer6" class="ai-container" style="text-align: center; margin-bottom: 20px; display: none;">
            <button class="btn btn-secondary" onclick="getAISuggestions('mission', 'love', 'needs')" id="aiBtn6" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                ‚ú® {{ t('ai_suggestions') }}
            </button>
            <div id="aiLoading6" style="display: none; margin-top: 10px; color: var(--purple);">
                <span class="spinner-border spinner-border-sm" role="status"></span> {{ t('analyzing_ai') }}
            </div>
        </div>
        
        <div class="input-group category-mission" id="missionInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="mission" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="mission" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="mission" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="mission" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="mission" data-index="4">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(6)" id="pauseBtn6">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 7: Vocation (World Needs + Can Be Paid) -->
    <div class="step-content" id="step7" data-step="7" data-time="120">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle7">
                <div class="timer-text" id="timer7">2:00</div>
            </div>
        </div>
        <h2 class="step-title">üåü {{ t('your_vocation') }}</h2>
        <p class="step-description">{{ t('your_vocation_desc') }}</p>
        
        <!-- Show previous answers -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; padding: 20px; background: var(--light-gray); border-radius: 15px;">
            <div style="padding: 15px; background: rgba(157, 128, 185, 0.1); border-radius: 10px; border-left: 3px solid var(--purple);">
                <h4 style="color: var(--purple); margin-bottom: 10px; font-size: 14px;">üåç {{ t('what_world_needs') }}:</h4>
                <div id="reviewNeeds2" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
            <div style="padding: 15px; background: rgba(11, 183, 183, 0.1); border-radius: 10px; border-left: 3px solid var(--turquoise);">
                <h4 style="color: var(--turquoise); margin-bottom: 10px; font-size: 14px;">üí∞ {{ t('what_paid_for') }}:</h4>
                <div id="reviewPaid" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
        </div>
        
        <!-- AI Suggestions Button -->
        <div id="aiContainer7" class="ai-container" style="text-align: center; margin-bottom: 20px; display: none;">
            <button class="btn btn-secondary" onclick="getAISuggestions('vocation', 'needs', 'paid')" id="aiBtn7" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                ‚ú® {{ t('ai_suggestions') }}
            </button>
            <div id="aiLoading7" style="display: none; margin-top: 10px; color: var(--purple);">
                <span class="spinner-border spinner-border-sm" role="status"></span> {{ t('analyzing_ai') }}
            </div>
        </div>
        
        <div class="input-group category-vocation" id="vocationInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="vocation" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="vocation" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="vocation" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="vocation" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="vocation" data-index="4">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(7)" id="pauseBtn7">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 8: Profession (Good At + Can Be Paid) -->
    <div class="step-content" id="step8" data-step="8" data-time="120">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle8">
                <div class="timer-text" id="timer8">2:00</div>
            </div>
        </div>
        <h2 class="step-title">üíº {{ t('your_profession') }}</h2>
        <p class="step-description">{{ t('your_profession_desc') }}</p>
        
        <!-- Show previous answers -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; padding: 20px; background: var(--light-gray); border-radius: 15px;">
            <div style="padding: 15px; background: rgba(0, 159, 213, 0.1); border-radius: 10px; border-left: 3px solid var(--sky-blue);">
                <h4 style="color: var(--sky-blue); margin-bottom: 10px; font-size: 14px;">‚≠ê {{ t('what_good_at') }}:</h4>
                <div id="reviewGood2" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
            <div style="padding: 15px; background: rgba(11, 183, 183, 0.1); border-radius: 10px; border-left: 3px solid var(--turquoise);">
                <h4 style="color: var(--turquoise); margin-bottom: 10px; font-size: 14px;">üí∞ {{ t('what_paid_for') }}:</h4>
                <div id="reviewPaid2" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
            </div>
        </div>
        
        <!-- AI Suggestions Button -->
        <div id="aiContainer8" class="ai-container" style="text-align: center; margin-bottom: 20px; display: none;">
            <button class="btn btn-secondary" onclick="getAISuggestions('profession', 'good', 'paid')" id="aiBtn8" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                ‚ú® {{ t('ai_suggestions') }}
            </button>
            <div id="aiLoading8" style="display: none; margin-top: 10px; color: var(--purple);">
                <span class="spinner-border spinner-border-sm" role="status"></span> {{ t('analyzing_ai') }}
            </div>
        </div>
        
        <div class="input-group category-profession" id="professionInputs">
            <div class="input-item">
                <div class="input-number">1</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="profession" data-index="0">
            </div>
            <div class="input-item">
                <div class="input-number">2</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="profession" data-index="1">
            </div>
            <div class="input-item">
                <div class="input-number">3</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="profession" data-index="2">
            </div>
            <div class="input-item">
                <div class="input-number">4</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="profession" data-index="3">
            </div>
            <div class="input-item">
                <div class="input-number">5</div>
                <input type="text" class="input-field" placeholder="{{ t('intersection_item') }}" data-category="profession" data-index="4">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(8)" id="pauseBtn8">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>

    <!-- Step 9: Your Ikigai -->
    <div class="step-content" id="step9" data-step="9" data-time="180">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle9">
                <div class="timer-text" id="timer9">3:00</div>
            </div>
        </div>
        <h2 class="step-title">‚ú® {{ t('your_divine_treasure') }} ‚ú®</h2>
        <p class="step-description">{{ t('your_divine_treasure_desc') }}</p>
        
        <!-- Review All Answers -->
        <div style="margin: 30px 0; padding: 30px; background: linear-gradient(135deg, rgba(11, 183, 183, 0.1) 0%, rgba(237, 74, 109, 0.1) 100%); border-radius: 20px;">
            <h3 style="text-align: center; color: var(--navy); margin-bottom: 25px; font-size: 24px;">üìã {{ t('summary_answers') }}</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- What You Love -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--pink); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--pink); margin-bottom: 10px; font-size: 16px;">‚ù§Ô∏è {{ t('what_you_love') }}</h4>
                    <div id="summaryLove" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
                
                <!-- What You're Good At -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--sky-blue); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--sky-blue); margin-bottom: 10px; font-size: 16px;">‚≠ê {{ t('what_good_at') }}</h4>
                    <div id="summaryGood" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
                
                <!-- What You Can Be Paid For -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--turquoise); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--turquoise); margin-bottom: 10px; font-size: 16px;">üí∞ {{ t('what_paid_for') }}</h4>
                    <div id="summaryPaid" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
                
                <!-- What The World Needs -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--purple); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--purple); margin-bottom: 10px; font-size: 16px;">üåç {{ t('what_world_needs') }}</h4>
                    <div id="summaryNeeds" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
                
                <!-- Passion -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--pink-light); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--pink); margin-bottom: 10px; font-size: 16px;">üíñ {{ t('your_passion') }}</h4>
                    <div id="summaryPassion" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
                
                <!-- Mission -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--purple); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--purple); margin-bottom: 10px; font-size: 16px;">üéØ {{ t('your_mission') }}</h4>
                    <div id="summaryMission" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
                
                <!-- Vocation -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--sky-blue); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--sky-blue); margin-bottom: 10px; font-size: 16px;">üåü {{ t('your_vocation') }}</h4>
                    <div id="summaryVocation" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
                
                <!-- Profession -->
                <div style="padding: 20px; background: white; border-radius: 15px; border-left: 4px solid var(--turquoise); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--turquoise); margin-bottom: 10px; font-size: 16px;">üíº {{ t('your_profession') }}</h4>
                    <div id="summaryProfession" style="font-size: 13px; line-height: 1.6; color: var(--navy);"></div>
                </div>
            </div>
        </div>
        
        <!-- AI Suggestions for Ikigai -->
        <div id="aiContainer9" class="ai-container" style="text-align: center; margin-bottom: 20px; display: none;">
            <button class="btn btn-secondary" onclick="getIkigaiSuggestions()" id="aiBtn9" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                ‚ú® {{ t('ai_suggestions') }}
            </button>
            <div id="aiLoading9" style="display: none; margin-top: 10px; color: var(--purple);">
                <span class="spinner-border spinner-border-sm" role="status"></span> {{ t('analyzing_ai') }}
            </div>
        </div>
        
        <!-- Visual Diagram -->
        <div id="ikigaiDiagram" style="margin: 40px auto; padding: 30px; background: white; border-radius: 20px; max-width: 800px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
            <div class="ikigai-map-inner" style="position: relative; width: 100%; max-width: 600px; margin: 0 auto; aspect-ratio: 1;">
                <!-- Center -->
                <div class="ikigai-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; background: linear-gradient(135deg, var(--turquoise) 0%, var(--sky-blue) 100%); color: white; padding: 20px 30px; border-radius: 50%; min-width: 120px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <div style="font-size: 12px; opacity: 0.9;">YOUR</div>
                    <div style="font-size: 16px; font-weight: bold;">IKIGAI</div>
                </div>
                
                <!-- Top Circle: Love -->
                <div class="ikigai-circle" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 220px; height: 220px; border: 3px solid var(--pink); border-radius: 50%; display: flex; align-items: start; justify-content: center; padding-top: 20px; background: rgba(237, 74, 109, 0.05);">
                    <div style="text-align: center; max-width: 80%;">
                        <div style="font-weight: bold; color: var(--pink); margin-bottom: 5px; font-size: 12px;">LOVE</div>
                        <div id="diagramLove" style="font-size: 10px; color: var(--navy); line-height: 1.3;"></div>
                    </div>
                </div>
                
                <!-- Bottom Circle: Paid -->
                <div class="ikigai-circle" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 220px; height: 220px; border: 3px solid var(--turquoise); border-radius: 50%; display: flex; align-items: end; justify-content: center; padding-bottom: 20px; background: rgba(11, 183, 183, 0.05);">
                    <div style="text-align: center; max-width: 80%;">
                        <div style="font-weight: bold; color: var(--turquoise); margin-bottom: 5px; font-size: 12px;">PAID</div>
                        <div id="diagramPaid" style="font-size: 10px; color: var(--navy); line-height: 1.3;"></div>
                    </div>
                </div>
                
                <!-- Left Circle: Good -->
                <div class="ikigai-circle" style="position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 220px; height: 220px; border: 3px solid var(--sky-blue); border-radius: 50%; display: flex; align-items: center; justify-content: start; padding-left: 20px; background: rgba(0, 159, 213, 0.05);">
                    <div style="text-align: left; max-width: 60%;">
                        <div style="font-weight: bold; color: var(--sky-blue); margin-bottom: 5px; font-size: 12px;">GOOD AT</div>
                        <div id="diagramGood" style="font-size: 10px; color: var(--navy); line-height: 1.3;"></div>
                    </div>
                </div>
                
                <!-- Right Circle: Needs -->
                <div class="ikigai-circle" style="position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 220px; height: 220px; border: 3px solid var(--purple); border-radius: 50%; display: flex; align-items: center; justify-content: end; padding-right: 20px; background: rgba(157, 128, 185, 0.05);">
                    <div style="text-align: right; max-width: 60%;">
                        <div style="font-weight: bold; color: var(--purple); margin-bottom: 5px; font-size: 12px;">WORLD NEEDS</div>
                        <div id="diagramNeeds" style="font-size: 10px; color: var(--navy); line-height: 1.3;"></div>
                    </div>
                </div>
                
                <!-- Intersection Labels -->
                <div class="ikigai-tag" style="position: absolute; top: 22%; left: 22%; transform: translate(-50%, -50%); background: var(--pink-light); color: white; padding: 5px 10px; border-radius: 15px; font-size: 9px; font-weight: bold;">Passion</div>
                <div class="ikigai-tag" style="position: absolute; top: 22%; right: 22%; transform: translate(50%, -50%); background: var(--purple); color: white; padding: 5px 10px; border-radius: 15px; font-size: 9px; font-weight: bold;">Mission</div>
                <div class="ikigai-tag" style="position: absolute; bottom: 22%; left: 22%; transform: translate(-50%, 50%); background: var(--sky-blue); color: white; padding: 5px 10px; border-radius: 15px; font-size: 9px; font-weight: bold;">Profession</div>
                <div class="ikigai-tag" style="position: absolute; bottom: 22%; right: 22%; transform: translate(50%, 50%); background: var(--turquoise); color: white; padding: 5px 10px; border-radius: 15px; font-size: 9px; font-weight: bold;">Vocation</div>
            </div>
        </div>
        
        <!-- Ikigai Keywords Input -->
        <div class="input-group" style="max-width: 700px; margin: 30px auto;" id="ikigaiInputs">
            <div class="input-item">
                <div class="input-number" style="background: linear-gradient(135deg, var(--turquoise) 0%, var(--pink) 100%);">1</div>
                <input type="text" class="input-field" placeholder="{{ t('first_keyword') }}" data-category="ikigai" data-index="0" style="font-size: 18px; font-weight: 600;">
            </div>
            <div class="input-item">
                <div class="input-number" style="background: linear-gradient(135deg, var(--turquoise) 0%, var(--pink) 100%);">2</div>
                <input type="text" class="input-field" placeholder="{{ t('second_keyword') }}" data-category="ikigai" data-index="1" style="font-size: 18px; font-weight: 600;">
            </div>
            <div class="input-item">
                <div class="input-number" style="background: linear-gradient(135deg, var(--turquoise) 0%, var(--pink) 100%);">3</div>
                <input type="text" class="input-field" placeholder="{{ t('third_keyword') }}" data-category="ikigai" data-index="2" style="font-size: 18px; font-weight: 600;">
            </div>
            <div class="input-item">
                <div class="input-number" style="background: linear-gradient(135deg, var(--turquoise) 0%, var(--pink) 100%);">4</div>
                <input type="text" class="input-field" placeholder="{{ t('fourth_keyword') }}" data-category="ikigai" data-index="3" style="font-size: 18px; font-weight: 600;">
            </div>
            <div class="input-item">
                <div class="input-number" style="background: linear-gradient(135deg, var(--turquoise) 0%, var(--pink) 100%);">5</div>
                <input type="text" class="input-field" placeholder="{{ t('fifth_keyword') }}" data-category="ikigai" data-index="4" style="font-size: 18px; font-weight: 600;">
            </div>
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(9)" id="pauseBtn9">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue') }} ‚Üí</button>
        </div>
    </div>
    
    <!-- Step 10: Ikigai Self-Evaluation -->
    <div class="step-content" id="step10" data-step="10" data-time="300">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle10">
                <div class="timer-text" id="timer10">5:00</div>
            </div>
        </div>
        <h2 class="step-title">üìä {{ t('evaluate_ikigai') }} ‚ú®</h2>
        <p class="step-description">{{ t('evaluate_ikigai_desc') }}</p>
        
        <!-- Dynamic Ikigai Keywords Evaluation (will be populated by JavaScript) -->
        <div id="ikigaiEvaluationContainer" style="max-width: 800px; margin: 0 auto;">
            <!-- JavaScript will insert evaluation cards here based on entered Ikigai keywords -->
        </div>
        
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
            <button class="btn btn-secondary" onclick="pauseTimer(10)" id="pauseBtn10">‚è∏ {{ t('pause') }}</button>
            <button class="btn btn-primary" onclick="nextStep()">{{ t('continue_to_impact') }} ‚Üí</button>
        </div>
    </div>
    
    <!-- Step 11: Impact Vision -->
    <div class="step-content" id="step11" data-step="11" data-time="300">
        <div class="timer-display">
            <div class="timer-circle" id="timerCircle11">
                <div class="timer-text" id="timer11">5:00</div>
            </div>
        </div>
        <h2 class="step-title">üåç {{ t('superpower_mission') }} üåç</h2>
        <p class="step-description">{{ t('superpower_mission_desc') }} ü¶∏‚Äç‚ôÇÔ∏è‚ú®</p>
        
        <div class="input-group" style="max-width: 800px; margin: 0 auto;">
            <div style="margin-bottom: 20px;">
                <textarea 
                    id="impactInput" 
                    class="input-field" 
                    placeholder="{{ t('impact_placeholder') }}"
                    style="width: 100%; min-height: 200px; padding: 20px; border-radius: 20px; font-size: 16px; line-height: 1.8; resize: vertical; font-family: inherit;"
                    data-category="impact"
                ></textarea>
            </div>
        </div>
        
            <div class="button-group" style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-secondary" onclick="goBackStep()" style="background: var(--light-gray); color: var(--navy);">‚Üê {{ t('back') }}</button>
                <button class="btn btn-secondary" onclick="pauseTimer(11)" id="pauseBtn11">‚è∏ {{ t('pause') }}</button>
                <button class="btn btn-primary btn-lg" onclick="submitExercise()" style="font-size: 20px; padding: 15px 50px; box-shadow: 0 10px 30px rgba(11, 183, 183, 0.5); animation: pulse 2s infinite;">
                    üéÅ {{ t('reveal_treasure') }}
                </button>
            </div>
    </div>

    <!-- Hidden form to submit data -->
    <form id="finalForm" action="/submit_exercise" method="post" style="display: none;">
        <input type="hidden" name="love" id="loveData">
        <input type="hidden" name="good" id="goodData">
        <input type="hidden" name="paid" id="paidData">
        <input type="hidden" name="needs" id="needsData">
        <input type="hidden" name="passion" id="passionData">
        <input type="hidden" name="mission" id="missionData">
        <input type="hidden" name="vocation" id="vocationData">
        <input type="hidden" name="profession" id="professionData">
        <input type="hidden" name="ikigai" id="ikigaiData">
        <input type="hidden" name="impact" id="impactData">
        <input type="hidden" name="ikigai_evaluations" id="ikigaiEvaluationsData">
    </form>
</div>

<script>
// Translations from server
const translations = {
    ready: "{{ t('ready') }}",
    start_timer: "{{ t('start_timer') }}",
    pause: "{{ t('pause') }}",
    continue: "{{ t('continue') }}",
    step_of: "{{ t('step_of', current='__CURRENT__', total='__TOTAL__') }}".replace('__CURRENT__', '{current}').replace('__TOTAL__', '{total}'),
    saved: "{{ t('saved') }}",
    no_answers_yet: "{{ t('no_answers_yet') }}",
    rate_keyword: "{{ t('rate_keyword') }}",
    improve_keyword: "{{ t('improve_keyword') }}",
    improvement_placeholder: "{{ t('improvement_placeholder') }}"
};

let currentStep = 1;
const totalSteps = 11;
let timers = {};
let timerIntervals = {};
let savedTimes = {};
let isPaused = {};
let outroPlayed = {};

// Audio elements
const introAudio = new Audio('/static/intro.mp3');
const outroAudio = new Audio('/static/outro.wav');

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
    loadSavedData();
    showInstructions(1);
    updateProgress();
});

// Auto-save data
function autoSaveData() {
    const data = {
        love: collectCategoryData('love'),
        good: collectCategoryData('good'),
        paid: collectCategoryData('paid'),
        needs: collectCategoryData('needs'),
        passion: collectCategoryData('passion'),
        mission: collectCategoryData('mission'),
        vocation: collectCategoryData('vocation'),
        profession: collectCategoryData('profession'),
        ikigai: collectCategoryData('ikigai'),
        impact: document.getElementById('impactInput')?.value || '',
        currentStep: currentStep
    };
    localStorage.setItem('ikigaiProgress', JSON.stringify(data));
    
    // Show save indicator
    const saveIndicator = document.getElementById('saveIndicator');
    if (saveIndicator) {
        saveIndicator.style.opacity = '1';
        setTimeout(() => {
            saveIndicator.style.opacity = '0';
        }, 1500);
    }
}

function collectCategoryData(category) {
    const inputs = document.querySelectorAll(`[data-category="${category}"]`);
    const values = [];
    inputs.forEach(input => {
        if (input.value.trim() !== '') {
            values.push(input.value);
        }
    });
    return values;
}

function loadSavedData() {
    // First check for language-change progress (priority)
    let saved = localStorage.getItem('ikigai_progress');
    let isLanguageChange = false;
    
    if (saved) {
        isLanguageChange = true;
    } else {
        // Otherwise load normal autosave
        saved = localStorage.getItem('ikigaiProgress');
    }
    
    if (saved) {
        try {
            const data = JSON.parse(saved);
            
            // Restore all input values
            restoreCategoryData('love', data.love || []);
            restoreCategoryData('good', data.good || []);
            restoreCategoryData('paid', data.paid || []);
            restoreCategoryData('needs', data.needs || []);
            restoreCategoryData('passion', data.passion || []);
            restoreCategoryData('mission', data.mission || []);
            restoreCategoryData('vocation', data.vocation || []);
            restoreCategoryData('profession', data.profession || []);
            restoreCategoryData('ikigai', data.ikigai || []);
            
            if (data.impact && document.getElementById('impactInput')) {
                document.getElementById('impactInput').value = data.impact;
            }
            
            // If this was a language change, also restore step and timers
            if (isLanguageChange && data.currentStep) {
                currentStep = data.currentStep;
                if (data.timers) {
                    savedTimes = data.timers;
                }
                // Clean up the language-change data
                localStorage.removeItem('ikigai_progress');
                
                // Navigate to the saved step after a short delay
                setTimeout(() => {
                    // Hide step 1 and show the saved step
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    
                    // Update progress bar
                    updateProgress();
                    
                    // Show the start button or continue with the step
                    const existingStart = document.getElementById(`startContainer${currentStep}`);
                    if (!existingStart) {
                        showInstructions(currentStep);
                    }
                }, 100);
            }
        } catch (e) {
            console.log('Error loading saved data:', e);
        }
    }
}

function restoreCategoryData(category, values) {
    const inputs = document.querySelectorAll(`[data-category="${category}"]`);
    inputs.forEach((input, index) => {
        if (values[index]) {
            input.value = values[index];
        }
    });
}

// Add auto-save on input change
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('input-field') || e.target.id === 'impactInput') {
        autoSaveData();
    }
});

function showInstructions(step) {
    // Hide timer and inputs initially
    const timerDisplay = document.querySelector(`#step${step} .timer-display`);
    const inputGroup = document.querySelector(`#step${step} .input-group`);
    const buttonGroup = document.querySelector(`#step${step} .button-group`);
    const stepDescription = document.querySelector(`#step${step} .step-description`);
    
    if (timerDisplay) timerDisplay.style.display = 'none';
    if (inputGroup) inputGroup.style.display = 'none';
    if (buttonGroup) buttonGroup.style.display = 'none';
    
    // Hide ALL AI suggestion containers while on instruction screen
    document.querySelectorAll('.ai-container').forEach(el => {
        el.style.display = 'none';
    });
    
    // Hide diagram if step 9
    if (step === 9) {
        const ikigaiDiagram = document.getElementById('ikigaiDiagram');
        if (ikigaiDiagram) ikigaiDiagram.style.display = 'none';
    }
    
    // Create and show start button - simpler version
    const startContainer = document.createElement('div');
    startContainer.id = `startContainer${step}`;
    startContainer.style.textAlign = 'center';
    startContainer.style.marginTop = '40px';
    startContainer.innerHTML = `
        <div style="font-size: 24px; color: var(--navy); margin-bottom: 20px; font-weight: 500;">
            ${translations.ready}
        </div>
        <button class="btn btn-primary btn-lg" onclick="startStep(${step})" style="font-size: 20px; padding: 15px 50px;">
            ${translations.start_timer}
        </button>
    `;
    
    if (stepDescription) {
        stepDescription.parentNode.insertBefore(startContainer, stepDescription.nextSibling);
    }
}

function startStep(step) {
    // Remove start button container
    const startContainer = document.getElementById(`startContainer${step}`);
    if (startContainer) startContainer.remove();
    
    // Hide hero message after first start
    const heroMessage = document.getElementById('heroMessage');
    if (heroMessage && step === 1) {
        heroMessage.style.display = 'none';
    }
    
    // Show timer, inputs, and buttons
    const timerDisplay = document.querySelector(`#step${step} .timer-display`);
    const inputGroup = document.querySelector(`#step${step} .input-group`);
    const buttonGroup = document.querySelector(`#step${step} .button-group`);
    
    if (timerDisplay) timerDisplay.style.display = 'block';
    if (inputGroup) inputGroup.style.display = 'block';
    if (buttonGroup) buttonGroup.style.display = 'flex';
    
    // Hide all AI containers then show only the current step's container after timer starts (steps 5-9)
    document.querySelectorAll('.ai-container').forEach(el => { el.style.display = 'none'; });
    if (step >= 5 && step <= 9) {
        const aiContainer = document.getElementById(`aiContainer${step}`);
        if (aiContainer) aiContainer.style.display = 'block';
    }
    
    // Show previous answers for intersection steps (5-8)
    if (step === 5) {
        showPreviousAnswers('love', 'reviewLove');
        showPreviousAnswers('good', 'reviewGood');
    } else if (step === 6) {
        showPreviousAnswers('love', 'reviewLove2');
        showPreviousAnswers('needs', 'reviewNeeds');
    } else if (step === 7) {
        showPreviousAnswers('needs', 'reviewNeeds2');
        showPreviousAnswers('paid', 'reviewPaid');
    } else if (step === 8) {
        showPreviousAnswers('good', 'reviewGood2');
        showPreviousAnswers('paid', 'reviewPaid2');
    }
    
    // If step 9, populate the diagram and summary
    if (step === 9) {
        const ikigaiDiagram = document.getElementById('ikigaiDiagram');
        if (ikigaiDiagram) ikigaiDiagram.style.display = 'block';
        populateDiagram();
        populateFullSummary();
    }
    
    // If step 10, generate ikigai evaluation cards
    if (step === 10) {
        generateIkigaiEvaluation();
    }
    
    // Play intro audio
    introAudio.currentTime = 0; // Reset to start
    introAudio.play().catch(e => console.log('Audio play failed:', e));
    
    // Start the timer
    startTimer(step);
    
    // Focus on first input
    const firstInput = document.querySelector(`#step${step} .input-field`);
    if (firstInput) firstInput.focus();
}

function showPreviousAnswers(category, targetElementId) {
    const inputs = document.querySelectorAll(`[data-category="${category}"]`);
    const values = [];
    
    inputs.forEach(input => {
        if (input.value.trim() !== '') {
            values.push(input.value.trim());
        }
    });
    
    const targetElement = document.getElementById(targetElementId);
    if (targetElement) {
        if (values.length > 0) {
            targetElement.innerHTML = values.map((val, idx) => `<div style="margin-bottom: 5px;"><strong>${idx + 1}.</strong> ${val}</div>`).join('');
        } else {
            targetElement.innerHTML = `<em style="opacity: 0.6;">${translations.no_answers_yet}</em>`;
        }
    }
}

function populateFullSummary() {
    // Populate all 8 sections in the summary
    const categories = ['love', 'good', 'paid', 'needs', 'passion', 'mission', 'vocation', 'profession'];
    
    categories.forEach(category => {
        const inputs = document.querySelectorAll(`[data-category="${category}"]`);
        const values = [];
        
        inputs.forEach(input => {
            if (input.value.trim() !== '') {
                values.push(input.value.trim());
            }
        });
        
        const targetElement = document.getElementById(`summary${category.charAt(0).toUpperCase() + category.slice(1)}`);
        if (targetElement) {
            if (values.length > 0) {
                targetElement.innerHTML = values.map((val, idx) => `<div style="margin-bottom: 6px;"><strong style="color: var(--turquoise);">${idx + 1}.</strong> ${val}</div>`).join('');
            } else {
                targetElement.innerHTML = '<em style="opacity: 0.5; font-size: 12px;">Sin respuestas</em>';
            }
        }
    });
}

function populateDiagram() {
    // Collect data from previous steps
    const loveInputs = document.querySelectorAll('[data-category="love"]');
    const goodInputs = document.querySelectorAll('[data-category="good"]');
    const paidInputs = document.querySelectorAll('[data-category="paid"]');
    const needsInputs = document.querySelectorAll('[data-category="needs"]');
    
    // Get filled values
    const loveValues = Array.from(loveInputs).map(input => input.value).filter(v => v.trim() !== '');
    const goodValues = Array.from(goodInputs).map(input => input.value).filter(v => v.trim() !== '');
    const paidValues = Array.from(paidInputs).map(input => input.value).filter(v => v.trim() !== '');
    const needsValues = Array.from(needsInputs).map(input => input.value).filter(v => v.trim() !== '');
    
    // Populate diagram
    document.getElementById('diagramLove').textContent = loveValues.slice(0, 3).join(', ') + (loveValues.length > 3 ? '...' : '');
    document.getElementById('diagramGood').textContent = goodValues.slice(0, 3).join(', ') + (goodValues.length > 3 ? '...' : '');
    document.getElementById('diagramPaid').textContent = paidValues.slice(0, 3).join(', ') + (paidValues.length > 3 ? '...' : '');
    document.getElementById('diagramNeeds').textContent = needsValues.slice(0, 3).join(', ') + (needsValues.length > 3 ? '...' : '');
}

function generateIkigaiEvaluation() {
    // Get the ikigai keywords entered by the user
    const ikigaiInputs = document.querySelectorAll('[data-category="ikigai"]');
    const ikigaiKeywords = [];
    
    ikigaiInputs.forEach((input, index) => {
        if (input.value.trim() !== '') {
            ikigaiKeywords.push({
                keyword: input.value.trim(),
                index: index
            });
        }
    });
    
    // Generate evaluation cards for each keyword
    const container = document.getElementById('ikigaiEvaluationContainer');
    if (!container) return;
    
    if (ikigaiKeywords.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--navy); opacity: 0.7;">
                <p style="font-size: 18px;">‚ö†Ô∏è No se encontraron palabras clave del Ikigai</p>
                <p style="font-size: 14px; margin-top: 10px;">Por favor regresa al paso anterior y define tu Ikigai.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    ikigaiKeywords.forEach(({ keyword, index }) => {
        const colors = ['var(--pink)', 'var(--turquoise)', 'var(--sky-blue)', 'var(--purple)', 'var(--teal-dark)'];
        const color = colors[index % colors.length];
        
        html += `
            <div style="background: white; padding: 30px; border-radius: 20px; border-left: 5px solid ${color}; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px;">
                <h3 style="color: ${color}; margin-bottom: 20px; font-size: 24px; font-weight: bold;">
                    ‚ú® ${keyword}
                </h3>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; color: var(--navy); font-weight: 600; margin-bottom: 12px; font-size: 16px;">
                        ${translations.rate_keyword} (1-10)
                    </label>
                    <input type="range" 
                           name="ikigai_rating_${index}" 
                           id="ikigai_rating_${index}"
                           min="1" 
                           max="10" 
                           value="5" 
                           oninput="document.getElementById('rating_display_${index}').textContent = this.value"
                           style="width: 100%; accent-color: ${color};">
                    <div id="rating_display_${index}" style="text-align: center; font-size: 32px; font-weight: bold; color: ${color}; margin-top: 10px;">5</div>
                </div>
                
                <div>
                    <label style="display: block; color: var(--navy); font-weight: 600; margin-bottom: 12px; font-size: 16px;">
                        ${translations.improve_keyword}
                    </label>
                    <textarea 
                        name="ikigai_improvement_${index}" 
                        id="ikigai_improvement_${index}"
                        rows="3" 
                        placeholder="${translations.improvement_placeholder}"
                        style="width: 100%; padding: 15px; border: 2px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; font-family: inherit; resize: vertical; transition: border 0.3s;"
                        onfocus="this.style.borderColor='${color}'"
                        onblur="this.style.borderColor='rgba(0,0,0,0.1)'"
                    ></textarea>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function goBackStep() {
    if (currentStep <= 1) {
        return;
    }
    
    // Auto-save current progress before going back
    autoSaveData();
    
    // Stop current timer
    stopTimer(currentStep);
    
    // Hide current step
    document.getElementById(`step${currentStep}`).classList.remove('active');
    
    // Go back one step
    currentStep--;
    document.getElementById(`step${currentStep}`).classList.add('active');
    
    // Show the instruction screen again (but keep the data)
    // First, check if the previous step already has the start container
    const existingStart = document.getElementById(`startContainer${currentStep}`);
    if (!existingStart) {
        showInstructions(currentStep);
    } else {
        // Already has start button, just scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Update progress
    updateProgress();
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function startTimer(step) {
    const stepElement = document.getElementById(`step${step}`);
    const timerDisplay = document.getElementById(`timer${step}`);
    
    // Use saved time if available, otherwise use default time
    let remainingTime = savedTimes[step] !== undefined ? savedTimes[step] : parseInt(stepElement.dataset.time);
    timers[step] = remainingTime;
    
    // Reset outro flag
    outroPlayed[step] = false;
    
    // Clear any existing interval
    if (timerIntervals[step]) {
        clearInterval(timerIntervals[step]);
    }
    
    timerIntervals[step] = setInterval(() => {
        remainingTime--;
        timers[step] = remainingTime;
        savedTimes[step] = remainingTime;
        
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Play outro audio 10 seconds before the end
        if (remainingTime === 10 && !outroPlayed[step]) {
            outroAudio.currentTime = 0;
            outroAudio.play().catch(e => console.log('Outro audio play failed:', e));
            outroPlayed[step] = true;
        }
        
        // Add warning animation when time is low
        if (remainingTime <= 30) {
            timerDisplay.classList.add('timer-warning');
        }
        
        // Auto advance when time runs out
        if (remainingTime <= 0) {
            clearInterval(timerIntervals[step]);
            savedTimes[step] = undefined; // Reset saved time
            if (step < totalSteps) {
                nextStep();
            }
        }
    }, 1000);
}

function stopTimer(step) {
    if (timerIntervals[step]) {
        clearInterval(timerIntervals[step]);
    }
}

function nextStep() {
    if (currentStep >= totalSteps) {
        return;
    }
    
    // Auto-save before moving to next step
    autoSaveData();
    
    // Stop current timer
    stopTimer(currentStep);
    
    // Reset pause state and saved time for current step
    isPaused[currentStep] = false;
    savedTimes[currentStep] = undefined;
    
    // Hide current step
    document.getElementById(`step${currentStep}`).classList.remove('active');
    
    // Show next step
    currentStep++;
    document.getElementById(`step${currentStep}`).classList.add('active');
    
    // Show instructions for next step
    showInstructions(currentStep);
    
    // Update progress
    updateProgress();
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function pauseTimer(step) {
    const pauseBtn = document.getElementById(`pauseBtn${step}`);
    
    if (isPaused[step]) {
        // Resume
        introAudio.currentTime = 0;
        introAudio.play().catch(e => console.log('Resume audio play failed:', e));
        startTimer(step);
        pauseBtn.textContent = '‚è∏ {{ t('pause') }}';
        pauseBtn.style.background = 'var(--purple)';
        isPaused[step] = false;
    } else {
        // Pause
        stopTimer(step);
        pauseBtn.textContent = '‚ñ∂ Resume';
        pauseBtn.style.background = 'var(--pink)';
        isPaused[step] = true;
    }
}

function updateProgress() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('stepIndicator').textContent = translations.step_of.replace('{current}', currentStep).replace('{total}', totalSteps);
}

function collectData() {
    const data = {
        love: [],
        good: [],
        paid: [],
        needs: [],
        passion: [],
        mission: [],
        vocation: [],
        profession: [],
        ikigai: [],
        impact: ''
    };
    
    // Collect all input values
    document.querySelectorAll('.input-field:not(textarea)').forEach(input => {
        const category = input.dataset.category;
        const value = input.value.trim();
        if (value && category && category !== 'undefined') {
            if (Array.isArray(data[category])) {
                data[category].push(value);
            } else {
                data[category] = value;
            }
        }
    });
    
    // Get impact textarea
    const impactInput = document.getElementById('impactInput');
    if (impactInput) {
        data.impact = impactInput.value.trim();
    }
    
    return data;
}

function submitExercise() {
    const data = collectData();
    
    // Validate ikigai is filled (at least 2 keywords)
    if (!data.ikigai || data.ikigai.length < 2) {
        alert('Please write at least 2 keywords for your Ikigai before submitting!');
        return;
    }
    
    // Validate impact is filled
    if (!data.impact) {
        alert('Please describe your impact vision before submitting!');
        return;
    }
    
    // Collect ikigai evaluations
    const evaluations = [];
    const ikigaiInputs = document.querySelectorAll('[data-category="ikigai"]');
    ikigaiInputs.forEach((input, index) => {
        if (input.value.trim() !== '') {
            const ratingInput = document.getElementById(`ikigai_rating_${index}`);
            const improvementInput = document.getElementById(`ikigai_improvement_${index}`);
            
            evaluations.push({
                keyword: input.value.trim(),
                rating: ratingInput ? parseInt(ratingInput.value) : 5,
                improvement: improvementInput ? improvementInput.value.trim() : ''
            });
        }
    });
    
    // Stop timer
    stopTimer(currentStep);
    
    // Fill hidden form fields
    document.getElementById('loveData').value = JSON.stringify(data.love);
    document.getElementById('goodData').value = JSON.stringify(data.good);
    document.getElementById('paidData').value = JSON.stringify(data.paid);
    document.getElementById('needsData').value = JSON.stringify(data.needs);
    document.getElementById('passionData').value = JSON.stringify(data.passion);
    document.getElementById('missionData').value = JSON.stringify(data.mission);
    document.getElementById('vocationData').value = JSON.stringify(data.vocation);
    document.getElementById('professionData').value = JSON.stringify(data.profession);
    document.getElementById('ikigaiData').value = JSON.stringify(data.ikigai);
    document.getElementById('impactData').value = data.impact;
    document.getElementById('ikigaiEvaluationsData').value = JSON.stringify(evaluations);
    
    // Clear saved progress
    localStorage.removeItem('ikigaiProgress');
    
    // Submit form
    document.getElementById('finalForm').submit();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
        if (currentStep < totalSteps) {
            nextStep();
        } else {
            submitExercise();
        }
    }
});

// ========== AI FUNCTIONS ==========

async function getAISuggestions(intersectionType, category1Name, category2Name) {
    const stepNum = intersectionType === 'passion' ? 5 : intersectionType === 'mission' ? 6 : intersectionType === 'vocation' ? 7 : 8;
    const btnId = `aiBtn${stepNum}`;
    const loadingId = `aiLoading${stepNum}`;
    
    // Get data from categories
    const category1Data = collectCategoryData(category1Name);
    const category2Data = collectCategoryData(category2Name);
    
    if (!category1Data.length && !category2Data.length) {
        alert('Por favor completa las secciones anteriores primero para obtener sugerencias.');
        return;
    }
    
    // Show loading
    document.getElementById(btnId).disabled = true;
    document.getElementById(loadingId).style.display = 'block';
    
    try {
        const response = await fetch('/ai/suggest_intersection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                category1: category1Data,
                category2: category2Data,
                intersection_name: intersectionType
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Fill in the suggestions (user can modify)
        const inputs = document.querySelectorAll(`[data-category="${intersectionType}"]`);
        data.suggestions.forEach((suggestion, index) => {
            if (inputs[index] && !inputs[index].value) {
                inputs[index].value = suggestion;
                // Trigger change event to save
                inputs[index].dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
        
        // Show success message
        alert(`‚ú® IA ha sugerido ${data.suggestions.length} ideas para tu ${intersectionType}. ¬°Puedes editarlas como desees!`);
        
    } catch (error) {
        console.error('AI Error:', error);
        alert('Hubo un error al obtener sugerencias. Por favor verifica tu configuraci√≥n de OpenAI API.');
    } finally {
        document.getElementById(btnId).disabled = false;
        document.getElementById(loadingId).style.display = 'none';
    }
}

async function getIkigaiSuggestions() {
    const btnId = 'aiBtn9';
    const loadingId = 'aiLoading9';
    
    // Collect all intersection data
    const passionData = collectCategoryData('passion');
    const missionData = collectCategoryData('mission');
    const vocationData = collectCategoryData('vocation');
    const professionData = collectCategoryData('profession');
    
    if (!passionData.length && !missionData.length && !vocationData.length && !professionData.length) {
        alert('Por favor completa las secciones de Pasi√≥n, Misi√≥n, Vocaci√≥n y Profesi√≥n primero.');
        return;
    }
    
    // Show loading
    document.getElementById(btnId).disabled = true;
    document.getElementById(loadingId).style.display = 'block';
    
    try {
        const response = await fetch('/ai/suggest_ikigai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                passion: passionData,
                mission: missionData,
                vocation: vocationData,
                profession: professionData
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Fill in the Ikigai keywords
        const inputs = document.querySelectorAll('[data-category="ikigai"]');
        data.suggestions.forEach((suggestion, index) => {
            if (inputs[index] && !inputs[index].value) {
                inputs[index].value = suggestion;
                inputs[index].dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
        
        alert(`‚ú® IA ha generado ${data.suggestions.length} palabras clave para tu Ikigai. ¬°Aj√∫stalas a tu gusto!`);
        
    } catch (error) {
        console.error('AI Error:', error);
        alert('Hubo un error al generar tu Ikigai. Por favor verifica tu configuraci√≥n de OpenAI API.');
    } finally {
        document.getElementById(btnId).disabled = false;
        document.getElementById(loadingId).style.display = 'none';
    }
}
</script>

{% endblock %}
